# ================================================================
# GANN QUANT AI - RISK MANAGEMENT CONFIGURATION v3.0
# ================================================================
# Comprehensive risk management system
# Based on 20 years of institutional trading experience
# ================================================================

version: "3.0.0"

# ================================================================
# POSITION SIZING
# ================================================================
position_sizing:
  
  # Primary method
  method: "kelly_criterion"  # kelly_criterion | fixed_percent | volatility_adjusted | optimal_f
  
  # Fixed percentage method
  fixed_percent:
    enabled: true
    risk_per_trade: 0.02  # 2% of account per trade
    
    # Adjustments by win rate
    adjustments:
      win_rate_high: 0.03  # 3% if win rate > 60%
      win_rate_low: 0.01   # 1% if win rate < 45%
      
  # Kelly Criterion
  kelly:
    enabled: true
    
    # Classic Kelly formula: f* = (bp - q) / b
    # f* = fraction of capital to risk
    # b = odds received (reward/risk ratio)
    # p = probability of winning
    # q = probability of losing (1-p)
    
    calculation:
      win_rate: "dynamic"  # dynamic | fixed
      reward_risk: "per_trade"
      
    # Kelly fraction adjustments
    fraction:
      full_kelly: 1.0
      half_kelly: 0.5  # Recommended for volatility
      quarter_kelly: 0.25  # Conservative
      
    # Active fraction
    active_fraction: 0.5  # Use half-Kelly for safety
    
    # Constraints
    constraints:
      max_position_size: 0.05  # Max 5% per trade
      min_position_size: 0.01  # Min 1% per trade
      
  # Volatility-adjusted sizing
  volatility_adjusted:
    enabled: true
    
    # ATR-based position sizing
    atr:
      enabled: true
      period: 14
      multiplier: 2.0
      
    # Calculate position size to risk fixed $ amount
    # Position Size = Risk Amount / (ATR * multiplier)
    
    risk_amount:
      method: "percent_of_equity"  # percent_of_equity | fixed_dollars
      percent: 0.02  # 2% of equity
      
  # Optimal F (Ralph Vince)
  optimal_f:
    enabled: false
    calculation_period: 100  # trades

# ================================================================
# STOP LOSS MANAGEMENT
# ================================================================
stop_loss:
  
  # Stop loss types
  types:
    
    # Fixed stop loss
    fixed:
      enabled: true
      pips: 50
      percent: 2.0
      
    # ATR-based stop
    atr_based:
      enabled: true
      multiplier: 2.0
      period: 14
      min_distance_pips: 20
      
    # Support/Resistance based
    sr_based:
      enabled: true
      buffer_pips: 5  # Place stop X pips beyond S/R
      
    # Gann level based
    gann_based:
      enabled: true
      use_nearest_level: true
      buffer_pips: 3
      
    # Volatility percentile
    volatility_based:
      enabled: true
      percentile: 80  # Use 80th percentile of recent volatility
      lookback: 50
      
  # Trailing stop
  trailing:
    enabled: true
    
    # Trailing methods
    methods:
      
      # Fixed trailing stop
      fixed:
        enabled: true
        distance_pips: 30
        activation_profit_pips: 50
        
      # ATR trailing
      atr:
        enabled: true
        multiplier: 2.5
        activation_profit_atr: 2.0
        
      # Parabolic SAR
      parabolic_sar:
        enabled: true
        acceleration: 0.02
        maximum: 0.2
        
      # Chandelier exit
      chandelier:
        enabled: true
        atr_multiplier: 3.0
        period: 22
        
  # Stop loss adjustment
  adjustment:
    breakeven:
      enabled: true
      trigger_profit_pips: 30
      lock_in_pips: 5
      
    profit_milestones:
      enabled: true
      milestones:
        - profit_pips: 50
          move_stop_to: 25
        - profit_pips: 100
          move_stop_to: 60
        - profit_pips: 150
          move_stop_to: 100
          
  # Time-based stop
  time_stop:
    enabled: true
    max_hold_hours: 72  # Exit after 72 hours regardless
    weekend_close: true  # Close before weekend

# ================================================================
# TAKE PROFIT MANAGEMENT
# ================================================================
take_profit:
  
  # Take profit methods
  methods:
    
    # Fixed R:R ratio
    fixed_rr:
      enabled: true
      ratio: 3.0  # 3:1 reward:risk
      
    # Multiple targets
    scaled_exits:
      enabled: true
      
      targets:
        - percent: 33  # Close 33% at target 1
          rr_ratio: 2.0
          
        - percent: 33  # Close 33% at target 2
          rr_ratio: 3.0
          
        - percent: 34  # Close remaining at target 3
          rr_ratio: 5.0
          
    # Resistance-based
    resistance_based:
      enabled: true
      use_gann_levels: true
      use_fibonacci: true
      buffer_pips: -3  # Exit before resistance
      
    # ATR-based targets
    atr_based:
      enabled: true
      targets:
        - multiplier: 2.0
          percent: 40
        - multiplier: 3.0
          percent: 35
        - multiplier: 5.0
          percent: 25
          
  # Profit protection
  protection:
    
    # Lock profit after X% gain
    lock_profit:
      enabled: true
      trigger_percent: 2.0  # After 2% gain
      lock_percent: 1.0     # Lock in 1% minimum
      
    # Trailing take profit
    trailing_tp:
      enabled: true
      activation_profit: 2.0  # R
      trail_by: 0.5  # Trail by 0.5R

# ================================================================
# RISK LIMITS
# ================================================================
risk_limits:
  
  # Per-trade limits
  per_trade:
    max_risk_percent: 0.05  # Max 5% risk per trade
    max_position_size: 0.10  # Max 10% of capital in one position
    
  # Daily limits
  daily:
    max_loss_percent: 0.05  # Stop trading after -5% daily loss
    max_loss_dollars: 5000
    max_trades: 10
    max_risk_exposure: 0.15  # Max 15% total risk exposure
    
  # Weekly limits
  weekly:
    max_loss_percent: 0.10  # -10% weekly loss limit
    max_consecutive_losses: 5
    
  # Monthly limits
  monthly:
    max_loss_percent: 0.15  # -15% monthly loss limit
    max_drawdown_percent: 0.20  # -20% drawdown limit
    
  # Position limits
  positions:
    max_open_positions: 5
    max_correlated_positions: 2  # Max positions in correlated instruments
    max_per_asset_class: 3
    
  # Leverage limits
  leverage:
    max_leverage: 10
    
    # By asset class
    by_asset:
      forex: 100
      crypto: 10
      stocks: 5
      indices: 50
      commodities: 50

# ================================================================
# CORRELATION MANAGEMENT
# ================================================================
correlation:
  
  enabled: true
  
  # Correlation calculation
  calculation:
    method: "pearson"  # pearson | spearman
    period: 50  # bars
    update_frequency: "daily"
    
  # Correlation matrix
  matrix:
    calculate: true
    instruments: "all_active"
    
  # Position adjustment
  adjustment:
    enabled: true
    
    # Reduce position size for highly correlated trades
    high_correlation_threshold: 0.7
    size_reduction: 0.5  # Reduce by 50%
    
    # Avoid highly correlated positions
    avoid_threshold: 0.85
    
  # Hedge detection
  hedge:
    detect_natural_hedges: true
    allow_hedged_positions: true

# ================================================================
# VOLATILITY FILTERING
# ================================================================
volatility:
  
  # Volatility calculation
  calculation:
    method: "atr"  # atr | stddev | parkinson
    period: 14
    
  # Volatility regimes
  regimes:
    enabled: true
    
    low:
      threshold_percentile: 33
      max_position_size: 0.04  # 4%
      min_rr: 2.5
      
    normal:
      threshold_percentile: [33, 66]
      max_position_size: 0.03  # 3%
      min_rr: 2.0
      
    high:
      threshold_percentile: 66
      max_position_size: 0.02  # 2%
      min_rr: 3.0
      
  # Volatility filters
  filters:
    min_volatility: 0.5  # Avoid dead markets
    max_volatility: 3.0  # Avoid crazy markets
    
    # Adjust stops for volatility
    volatility_stops: true

# ================================================================
# DRAWDOWN MANAGEMENT
# ================================================================
drawdown:
  
  # Drawdown tracking
  tracking:
    enabled: true
    calculate_realtime: true
    
    types:
      - "absolute"  # From peak equity
      - "relative"  # Percentage from peak
      - "maximum"   # Largest historical DD
      
  # Drawdown limits
  limits:
    warning_level: 0.10  # Warning at -10%
    critical_level: 0.15  # Critical at -15%
    max_level: 0.20      # Stop at -20%
    
  # Recovery rules
  recovery:
    enabled: true
    
    # Reduce risk during drawdown
    risk_reduction:
      enabled: true
      at_10_percent: 0.5  # Reduce risk by 50%
      at_15_percent: 0.25  # Reduce risk by 75%
      
    # Pause trading during severe drawdown
    pause_trading:
      enabled: true
      threshold: 0.15
      cooldown_days: 7
      
    # Recovery mode
    recovery_mode:
      enabled: true
      gradual_increase: true
      increase_after_wins: 3

# ================================================================
# MARKET CONDITION FILTERS
# ================================================================
market_filters:
  
  # Spread filter
  spread:
    enabled: true
    max_spread_pips: 3.0
    max_spread_percent: 0.1
    
  # Liquidity filter
  liquidity:
    enabled: true
    min_volume: 1000
    avoid_thin_markets: true
    
  # News filter
  news:
    enabled: true
    avoid_high_impact: true
    buffer_minutes: 30
    
  # Market hours filter
  hours:
    enabled: true
    preferred_sessions: ["london", "new_york"]
    avoid_asian_session: false
    
  # Trend filter
  trend:
    enabled: true
    min_adx: 25  # Avoid choppy markets
    
  # Market regime
  regime:
    enabled: true
    detect_regime: true
    
    regimes:
      trending:
        strategy_adjustments:
          increase_targets: 1.2
          wider_stops: 1.1
          
      ranging:
        strategy_adjustments:
          reduce_targets: 0.8
          tighter_stops: 0.9
          mean_reversion: true
          
      volatile:
        strategy_adjustments:
          reduce_size: 0.5
          wider_stops: 1.5
          higher_rr: 3.0

# ================================================================
# EXPOSURE MANAGEMENT
# ================================================================
exposure:
  
  # Total exposure limits
  total:
    max_gross_exposure: 0.30  # 30% of capital at risk
    max_net_exposure: 0.20     # 20% directional exposure
    
  # By asset class
  by_asset_class:
    forex:
      max_exposure: 0.15
      max_positions: 3
      
    crypto:
      max_exposure: 0.10
      max_positions: 2
      
    indices:
      max_exposure: 0.15
      max_positions: 3
      
    commodities:
      max_exposure: 0.10
      max_positions: 2
      
  # By currency
  by_currency:
    enabled: true
    max_per_currency: 0.15  # Max 15% exposure to single currency
    
  # Sector exposure (stocks)
  by_sector:
    enabled: true
    max_per_sector: 0.20

# ================================================================
# PORTFOLIO HEAT
# ================================================================
portfolio_heat:
  
  enabled: true
  
  # Heat calculation
  calculation:
    method: "sum_of_risks"  # sum_of_risks | variance_adjusted
    
  # Heat limits
  limits:
    max_portfolio_heat: 0.12  # 12% total risk
    warning_level: 0.10
    
  # Heat reduction
  reduction:
    auto_reduce: true
    reduce_newest: true  # Close newest positions first
    reduce_worst: false  # vs close worst performing

# ================================================================
# ACCOUNT PROTECTION
# ================================================================
account_protection:
  
  # Equity protection
  equity:
    min_equity_percent: 0.80  # Never drop below 80% of peak
    
  # Consecutive losses
  consecutive_losses:
    max_count: 5
    action: "pause_trading"
    cooldown_hours: 24
    
  # Win rate monitoring
  win_rate:
    min_acceptable: 0.40  # 40% win rate minimum
    evaluation_period: 30  # trades
    action_below_min: "reduce_size"
    
  # Profit factor
  profit_factor:
    min_acceptable: 1.5
    evaluation_period: 50  # trades
    
  # Circuit breaker
  circuit_breaker:
    enabled: true
    
    triggers:
      - rapid_loss: -0.03  # -3% in 1 hour
      - daily_limit: -0.05
      - technical_error: true
      
    action: "close_all_positions"
    manual_restart_required: true

# ================================================================
# RISK REPORTING
# ================================================================
reporting:
  
  # Real-time monitoring
  realtime:
    enabled: true
    update_frequency: 60  # seconds
    
    metrics:
      - "current_exposure"
      - "portfolio_heat"
      - "daily_pnl"
      - "open_positions"
      - "available_margin"
      
  # Daily reports
  daily:
    enabled: true
    time: "17:00"  # UTC
    
    include:
      - "risk_metrics"
      - "position_summary"
      - "pnl_breakdown"
      - "limit_utilization"
      
  # Alerts
  alerts:
    enabled: true
    
    alert_on:
      - "limit_breach"
      - "high_exposure"
      - "large_loss"
      - "margin_warning"
      - "correlation_spike"
      
    channels: ["telegram", "email", "webhook"]

# ================================================================
# KELLY CRITERION ADVANCED
# ================================================================
kelly_advanced:
  
  # Dynamic Kelly calculation
  dynamic:
    enabled: true
    recalculate_frequency: "per_trade"
    
    # Inputs
    win_rate:
      method: "rolling"  # rolling | expanding | fixed
      period: 50  # last 50 trades
      min_trades: 20
      
    avg_win_loss:
      method: "rolling"
      period: 50
      outlier_removal: true
      
  # Kelly adjustments
  adjustments:
    
    # Reduce Kelly for uncertainty
    confidence_adjustment:
      enabled: true
      low_confidence_multiplier: 0.25
      high_confidence_multiplier: 0.75
      
    # Account for black swan events
    tail_risk:
      enabled: true
      reduction_factor: 0.20  # Reduce Kelly by 20% for tail risk